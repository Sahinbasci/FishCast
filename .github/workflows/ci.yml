name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  backend-test:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: backend

    steps:
      - uses: actions/checkout@v4

      - name: Check for secret leaks
        working-directory: .
        run: |
          PATTERN="PRIV""ATE KEY"
          if grep -rn "$PATTERN" --include="*.py" --include="*.json" --include="*.yaml" --include="*.ts" --include="*.tsx" --exclude-dir=.git --exclude-dir=node_modules . 2>/dev/null; then
            echo "ERROR: Potential secret/private key leak detected in source"
            exit 1
          fi
          echo "Secret leak check passed"

      - name: Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: pip
          cache-dependency-path: backend/requirements.txt

      - name: Install dependencies
        run: pip install -r requirements.txt pytest pytest-asyncio pytest-cov ruff mypy

      - name: Lint with ruff
        run: ruff check app/ tests/ --output-format=github

      - name: Type check with mypy
        run: mypy app/ --ignore-missing-imports --no-strict-optional --allow-untyped-defs
        continue-on-error: true  # advisory until full type coverage

      - name: Run unit tests with coverage
        run: python -m pytest tests/ -v --tb=short --cov=app --cov-report=term-missing --cov-fail-under=40

      - name: Run smoke test (offline)
        run: python scripts/smoke_decision.py
        env:
          OFFLINE_MODE: "true"

  frontend-typecheck:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: frontend

    steps:
      - uses: actions/checkout@v4

      - name: Set up Node 20
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: npm
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: TypeScript type-check
        run: npx tsc --noEmit

      - name: Build
        run: npm run build
        env:
          NEXT_PUBLIC_API_URL: https://api.fishcast.app/api/v1

  docker-build:
    runs-on: ubuntu-latest
    needs: [backend-test]
    # Only on main branch, never from forks
    if: github.ref == 'refs/heads/main' && github.repository_owner == 'Sahinbasci'

    steps:
      - uses: actions/checkout@v4

      - name: Build Docker image
        run: docker build -t fishcast-api:${{ github.sha }} ./backend
